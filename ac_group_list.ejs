<%- include ("_headerpersonnelAlerts") %>
<style>
  th.col-rights, td.col-rights,
  th.col-rights2, td.col-rights2,
  th.col-rights3, td.col-rights3 { width: 50px; white-space: nowrap; }
  th.col-rights4, td.col-rights4 { width: 65px; white-space: nowrap; }

  #citizenTable th, #citizenTable td { vertical-align: middle; }

  /* คอลัมน์ที่ 9 (เครื่องมือ) และ 8 (Temperature) */
  #citizenTable td:nth-child(8), #citizenTable th:nth-child(8),
  #citizenTable td:nth-child(9), #citizenTable th:nth-child(9) {
    text-align: center; white-space: nowrap;
  }
</style>

<body class="bg-light">
  <div class="container-fluid mt-4">
    <h4>รายชื่อประชาชนทั้งหมด (ตาม อสม.)</h4>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/personnelAlerts">หน้าหลัก</a></li>
        <li class="breadcrumb-item active" aria-current="page">รายชื่อประชาชน</li>
      </ol>
    </nav>

    <!-- แถบเครื่องมือด้านบน -->
    <div class="row g-2 align-items-end mb-3">
      <div class="col-sm-4">
        <label class="form-label">เลือก อสม.</label>
        <!-- Select2 จะใส่ช่องค้นหาไว้ "ภายใน dropdown" ให้อัตโนมัติ -->
        <select id="osmoSelect" class="form-select">
          <option value="">-- กรุณาเลือกชื่อ --</option>
          <% if (Array.isArray(osmos)) { osmos.forEach(o => { %>
            <option value="<%= o.id %>"><%= o.name %></option>
          <% }) } %>
        </select>
      </div>

      <div class="col-sm-8 text-end">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">
          + เพิ่มประชาชนเข้ากลุ่ม / มอบหมายให้ อสม.
        </button>
      </div>
    </div>

    <!-- ตารางหลัก -->
    <table id="citizenTable" class="table table-bordered table-striped mt-3">
      <thead class="table-light">
        <tr>
          <th>ลำดับ</th>
          <th>ชื่อ-นามสกุล</th>
          <th>อายุ</th>
          <th>หมู่บ้าน</th>
          <th>โรคประจำตัว</th>
          <th>สิทธิ์รักษา</th>
          <th>อสม.ผู้ดูแล</th>
          <th>Temperature</th>
          <!-- <th>เครื่องมือ</th> -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal ค้นหา/เพิ่ม -->
  <div class="modal fade" id="addMemberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ค้นหาและเพิ่มประชาชนเข้ากลุ่ม (และมอบหมาย อสม.)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info mb-2">
            อสม.ที่เลือกปัจจุบัน: <strong id="currentOsmoText">ยังไม่เลือก</strong>
          </div>
          <input type="text" id="searchInput" class="form-control mb-3" placeholder="พิมพ์ชื่อ หรือนามสกุล"/>
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>ชื่อ-นามสกุล</th>
                <th>เลือก</th>
              </tr>
            </thead>
            <tbody id="searchResults">
              <tr><td colspan="2" class="text-center">พิมพ์เพื่อค้นหา...</td></tr>
            </tbody>
          </table>
          <div class="small text-muted">การมอบหมายจะทำงานเฉพาะเมื่อเลือกอสม.ด้านบนแล้ว</div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(function () {
    // ---------- DataTable ----------
    const table = $("#citizenTable").DataTable({
      language: {
        search: "ค้นหา:", lengthMenu: "แสดง _MENU_ รายการ",
        info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
        paginate: { first: "หน้าแรก", last: "หน้าสุดท้าย", next: "ถัดไป", previous: "ก่อนหน้า" },
        emptyTable: "ยังไม่พบข้อมูล — กรุณาเลือกอสม."
      },
      columns: [
        { data: null, orderable: false, searchable: false,
          render: (_, __, ___, meta) => meta.row + 1 },
        { data: "fullname" },
        { data: "age", defaultContent: "-" },
        { data: "name_village", defaultContent: "-" },
        { data: "congenital", defaultContent: "-" },
        { data: "rights_name", defaultContent: "-" },
        { data: "osmo_name", defaultContent: "-" },
        { data: "group_member_id",
          render: id => `<a href="/temp-dataset/${id}">ดูอุณหภูมิ</a>`,
          className: "text-center align-middle" },
        // { data: null, orderable: false, searchable: false,
        //   render: (row) => {
        //     return `
        //       <button class="btn btn-outline-danger btn-sm btn-unassign" 
        //               data-member="${row.member_id}" data-osmo="${row.osmo_id}">
        //         ถอนมอบหมาย
        //       </button>`;
        //   },
        //   className: "text-center align-middle"
        // }
      ],
      order: []
    });

    // ---------- helper ----------
    function loadMembersByOsmo(osmoId) {
      table.clear().draw();
      if (!osmoId) return;

      $.getJSON(`/osmo/${osmoId}/members`)
        .done(list => {
          // server ควรคืน member_id, fullname, age, name_village, congenital, rights_name
          // เติม osmo_id และ osmo_name เพื่อแสดงในตาราง
          const withOsmo = (list || []).map(x => ({
            ...x,
            osmo_id: osmoId,
            osmo_name: $("#osmoSelect option:selected").text() || "-"
          }));
          table.rows.add(withOsmo).draw(false);
        })
        .fail(xhr => {
          console.error("loadMembers error:", xhr.responseText || xhr.statusText);
          alert("ดึงรายชื่อไม่สำเร็จ");
        });
    }

    function getSelectedOsmo() {
      const id = $("#osmoSelect").val();
      const text = $("#osmoSelect option:selected").text();
      return { id, text };
    }

    // ---------- เลือกอสม. ----------
    $("#osmoSelect").on("change", function () {
      const { id } = getSelectedOsmo();
      loadMembersByOsmo(id);
      $("#currentOsmoText").text(id ? $("#osmoSelect option:selected").text() : "ยังไม่เลือก");
    });

    // ---------- โมดัล: ค้นหา ----------
    let searchTimer = null;
    $("#searchInput").on("keyup", function () {
      const q = $(this).val().trim();

      clearTimeout(searchTimer);
      searchTimer = setTimeout(function () {
        if (q.length < 2) {
          $("#searchResults").html('<tr><td colspan="2" class="text-center">พิมพ์อย่างน้อย 2 ตัวอักษร...</td></tr>');
          return;
        }

        $("#searchResults").html('<tr><td colspan="2" class="text-center">กำลังค้นหา...</td></tr>');

        $.getJSON(`/group/search?q=${encodeURIComponent(q)}`)
          .done(data => {
            const arr = Array.isArray(data) ? data : (data.data || []);
            if (!arr || !arr.length) {
              $("#searchResults").html('<tr><td colspan="2" class="text-center">ไม่พบข้อมูล</td></tr>');
              return;
            }
            const rows = arr.map(m => `
              <tr>
                <td>${(m.fname_us || "")} ${(m.lname_us || "")}</td>
                <td>
                  <button class="btn btn-primary btn-sm select-member" data-id="${m.id}">
                    เลือก
                  </button>
                </td>
              </tr>`).join("");
            $("#searchResults").html(rows);
          })
          .fail(xhr => {
            console.error("search error:", xhr.responseText || xhr.statusText);
            $("#searchResults").html('<tr><td colspan="2" class="text-center text-danger">เกิดข้อผิดพลาดในการค้นหา</td></tr>');
          });
      }, 200);
    });

    // ---------- โมดัล: เลือกสมาชิก -> เพิ่มเข้ากลุ่ม และ (ถ้าเลือกอสม.) มอบหมายทันที ----------
    $(document).on("click", ".select-member", function (e) {
      e.preventDefault();

      const memberId = $(this).data("id");
      const { id: osmoId } = getSelectedOsmo();

      // 1) เพิ่มเข้าตาราง group_us_member ก่อน (กันกรณียังไม่เคยอยู่ในกลุ่ม)
      $.ajax({ url: `/group/add/${memberId}`, type: "POST", dataType: "json" })
        .done(data => {
          // 2) ถ้ามีการเลือกอสม.ไว้ ให้ assign ต่อทันที
          const assignIfNeeded = osmoId
            ? $.ajax({
                url: `/osmo/assign/${memberId}`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ osmo_id: osmoId })
              })
            : $.Deferred().resolve().promise();

          assignIfNeeded
            .done(() => {
              // รีโหลดรายการของอสม.ที่เลือก (หรือไม่เลือกก็ไม่ต้อง)
              if (osmoId) loadMembersByOsmo(osmoId);

              // ปิดโมดัล + เคลียร์
              const modalEl = document.getElementById("addMemberModal");
              const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
              modal.hide();
              setTimeout(() => {
                $(".modal-backdrop").remove();
                $("body").removeClass("modal-open").css("padding-right", "");
              }, 150);

              $("#searchInput").val("");
              $("#searchResults").html('<tr><td colspan="2" class="text-center">พิมพ์เพื่อค้นหา...</td></tr>');
            })
            .fail(xhr => {
              console.error("assign error:", xhr.responseText || xhr.statusText);
              alert(xhr.responseJSON?.error || "มอบหมายไม่สำเร็จ");
            });
        })
        .fail(xhr => {
          // ถ้าชนซ้ำใน group_us_member ก็แค่เดินหน้าทำ assign ต่อได้ (ไม่ถือว่าล้มเหลว)
          if (xhr.responseJSON && xhr.responseJSON.error === "มีสมาชิกคนนี้ในกลุ่มแล้ว") {
            const { id: osmoId2 } = getSelectedOsmo();
            if (!osmoId2) return; // ไม่ได้เลือกอสม. แค่นี้พอ

            $.ajax({
              url: `/osmo/assign/${memberId}`,
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify({ osmo_id: osmoId2 })
            })
            .done(() => {
              loadMembersByOsmo(osmoId2);
              const modalEl = document.getElementById("addMemberModal");
              const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
              modal.hide();
            })
            .fail(x => {
              console.error("assign error:", x.responseText || x.statusText);
              alert(x.responseJSON?.error || "มอบหมายไม่สำเร็จ");
            });

          } else {
            console.error("add member error:", xhr.responseText || xhr.statusText);
            alert("เพิ่มสมาชิกไม่สำเร็จ");
          }
        });
    });

    // ---------- ถอนมอบหมาย ----------
    $(document).on("click", ".btn-unassign", function () {
      const memberId = $(this).data("member");
      const osmoId = $(this).data("osmo");
      if (!osmoId) return alert("กรุณาเลือกอสม.ก่อน");

      if (!confirm("ยืนยันถอนการมอบหมาย?")) return;

      $.post(`/osmo/${osmoId}/unassign/${memberId}`)
        .done(() => loadMembersByOsmo(osmoId))
        .fail(xhr => {
          console.error("unassign error:", xhr.responseText || xhr.statusText);
          alert("ถอนมอบหมายไม่สำเร็จ");
        });
    });

    // ---------- เมื่อเปิดโมดัล อัปเดตชื่ออสม.ที่เลือก ----------
    $('#addMemberModal').on('shown.bs.modal', function () {
      const { id, text } = getSelectedOsmo();
      $("#currentOsmoText").text(id ? text : "ยังไม่เลือก");
      $("#searchInput").val("").focus();
      $("#searchResults").html('<tr><td colspan="2" class="text-center">พิมพ์เพื่อค้นหา...</td></tr>');
    });
  });

 $(function(){
  $('#osmoSelect').select2({
    theme: 'bootstrap',
    placeholder: '-- เลือกอสม. --',
    allowClear: true,
    width: '100%',
    minimumInputLength: 1,
    ajax: {
      url: '/osmo/search',
      delay: 250,
      data: params => ({ q: params.term || '' }),
      processResults: data => ({
        results: (data || []).map(o => ({ id: o.id, text: o.name }))
      }),
      cache: true
    }
  });

  // ให้ change เดิมทำงานเหมือนก่อน
  $('#osmoSelect').on('change', function(){
    const id = $(this).val();
    loadMembersByOsmo(id);
    $("#currentOsmoText").text(id ? $("#osmoSelect option:selected").text() : "ยังไม่เลือก");
  });
});
</script>
</body>
</html>
<%- include ("_footerpersonnelAlerts") %>
